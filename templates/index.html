{% extends "base.html" %}
{% block content %}

<!-- Encabezado con fecha, hora y tarifa -->
<div class="row mb-4 text-center">
  <div class="col-md-4">
    <div class="card shadow p-3 rounded-4">
      <h5>üìÖ Fecha</h5>
      <h3>{{ fecha }}</h3>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow p-3 rounded-4">
      <h5>‚è∞ Hora</h5>
      <h3 id="hora"></h3>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow p-3 rounded-4">
      <h5>üí∞ Tarifa por hora</h5>
      <h3>${{ precio }}</h3>
    </div>
  </div>
</div>

<!-- Formulario -->
<div class="card shadow-lg p-4 rounded-4 mb-5">
  <h3 class="mb-4 text-center fw-bold">üöó Registro de veh√≠culos</h3>
  <div class="row g-3 align-items-center">
    <div class="col-md-8">
      <div class="input-group input-group-lg">
        <span class="input-group-text bg-dark text-white">üöò</span>
        <input id="placa" class="form-control" placeholder="Ingrese la placa del veh√≠culo">
      </div>
    </div>
    <div class="col-md-4 d-grid gap-2">
      <button class="btn btn-success btn-lg" onclick="entrada()">‚úÖ Registrar Entrada</button>
      <button class="btn btn-danger btn-lg" onclick="salida()">‚ùå Registrar Salida</button>
      <button class="btn btn-primary btn-lg" onclick="toggleReporte()">üìä Ver Reporte</button>
    </div>
  </div>
</div>

<!-- Mensaje -->
<div class="mt-4">
  <div class="alert text-center" id="mensaje" style="display:none;"></div>
</div>

<!-- Secci√≥n de Reporte -->
<div id="reporte" style="display:none;" class="mt-5">
  <h3 class="mb-4">üìä Reporte Diario</h3>

  <div class="row mb-4 text-center">
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-body">
          <h5 class="card-title">Total Recaudado</h5>
          <h3 id="total" class="text-success">$0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-body">
          <h5 class="card-title">Veh√≠culos Registrados</h5>
          <h3 id="totalVehiculos">0</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <table class="table table-striped" id="tabla-reporte">
    <thead>
      <tr>
        <th>Placa</th>
        <th>Entrada</th>
        <th>Salida</th>
        <th>Costo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/reporte.js"></script>
<script>
/* === Toggle de Reporte === */
function toggleReporte() {
  let div = document.getElementById("reporte");
  div.style.display = (div.style.display === "none") ? "block" : "none";
}

/* === Reloj en vivo === */
function actualizarHora() {
  let ahora = new Date();
  document.getElementById("hora").textContent =
    ahora.toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
}
setInterval(actualizarHora, 1000);
actualizarHora();

/* === Funciones de API === */
async function entrada() {
  let placa = document.getElementById("placa").value.trim();
  if (!placa) return mostrarMensaje("‚ö†Ô∏è Debes ingresar una placa", true);
  let res = await fetch("/entrada", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({placa})
  });
  let data = await res.json();
  mostrarMensaje(data.mensaje || data.error, !!data.error);
}

async function salida() {
  let placa = document.getElementById("placa").value.trim();
  if (!placa) return mostrarMensaje("‚ö†Ô∏è Debes ingresar una placa", true);
  let res = await fetch("/salida", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({placa})
  });
  let data = await res.json();
  if (data.error) {
    mostrarMensaje(data.error, true);
  } else {
    mostrarMensaje("‚úÖ Salida registrada. Costo: $" + data.costo);
  }
}

function mostrarMensaje(texto, error=false) {
  let div = document.getElementById("mensaje");
  div.textContent = texto;
  div.className = error ? "alert alert-danger text-center" : "alert alert-success text-center";
  div.style.display = "block";
}
</script>
{% endblock %}
